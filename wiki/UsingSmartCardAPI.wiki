#summary Writing Android applications with access to Secure Elements using the SmartCard API


=Introduction=

This document explains how the !SmartCard API for can be used to
develop and test Android applications which communicate with Secure Elements available in the real device or the emulator.

The tutorial refers to the shared library based !SmartCard API implementing the Open Mobile API interface.


*Note:* Current devices do not support SIM access as the required changes in the baseband are not implemented yet thus SIM access can only be tested within the Android emulator. See [UICCSupport] for more information.<br/>

===Prerequisites===
  * The development phone is flashed with !SmartCard API support according to [BuildingTheSystem] or the _MSC !SmartCardService_ is installed and the integration is verified according to [IntegrationsTests]
  * Basic knowledge of [http://www.oracle.com/technetwork/java/javacard/overview/index.html Java Card] applets and [http://www.wrankl.de/SCH/SCH.html smart card] communication
  * Eclipse development IDE with the Android Development Tools (ADT) installed on the host (although Eclipse is not mandatory). See http://developer.android.com/sdk/eclipse-adt.html
  * Android SDK with [http://seek-for-android.googlecode.com/files/org.simalliance.openmobileapi.jar org.simalliance.openmobileapi.jar] or self compiled SDK
  * Basic understanding of the Android development platform. See http://developer.android.com/sdk/index.html<br/>

===Setting up the Environment===
The Eclipse development environment needs to be configured in order to use the official SDK from Google, alternatively the compiled SDK. 
The output of _make PRODUCT-sdk-sdk_ (compiled SDK) can be found under `<ANDROID_ROOT_DIR>/out/host/linux-x86/sdk/...`
 * Open Eclipse and go to Windows -> Preferences -> Android
 * Specify the SDK location on the local host like `<ANDROID_SDK_ROOT>`
<br/>

=Hello, Smart Card.=
For developers, the most important code to get started within a new development environment is the _Hello, World._ sample. The text to be displayed will be created from the applet installed on the Secure Element.<br/>
The Android application communicates with the applet installed on the Secure Element and displays the response from the APDU command on the screen of the device.<br/>
The _Hello Smartcard_ Java Card applet available in the SVN repository needs to be installed on the Secure Element by using any kind of card management tool similar to JLoad from the _Mobile Security Developers Kit_.<br/>
The sample code referenced here can also be found in the SVN repository.
  * Using the Eclipse project wizard, create a new Android project
    _File -> New -> Project_
  * Select _Android Project_ and click _Next_
  * To create the project, fill in the required fields
    Project name: _!HelloSmartcard_<br/>
    Application name: _Hello Smartcard_<br/>
    Package name: _com.gieseckedevrient.android.hellosmartcard_<br/>
    Create Activity: _!MainActivity_
  * Click _Finish_ to create the body of the (empty) Android application<br/>


To include Secure Element access, add the shared library classes included in `org.simalliance.openmobileapi.jar` to the project settings under _Java Build Path_.
 * _Java Build Path -> Tab: Libraries -> Add External JARs..._

Instead of using the download package [http://seek-for-android.googlecode.com/files/org.simalliance.openmobileapi.jar org.simalliance.openmobileapi.jar] the compiled version can be used alternatively located under:
{{{
<ANDROID_ROOT_DIR>/out/target/common/obj/JAVA_LIBRARIES/org.simalliance.openmobileapi_intermediates/classes-full-debug.jar
}}}

===uses-library in !AndroidManifest.xml===
Applications using the !SmartCard API can declare that the component is required in the system in order to be able to get installed. Especially when publishing the APKs to the Android Market it is recommended to declare such. However, devices having the MSC !SmartcardService installed will also provide the required component without the _uses-library_ element enabled.<br/>
An example of an `AndroidManifest.xml` which requires the Open Mobile API looks like

{{{
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
  <application android:label="@string/app_name">
    <activity android:name=".MainActivity"
      ...
    </activity>
    <uses-library android:name="org.simalliance.openmobileapi" android:required="false" />
  </application>
</manifest> 
}}}
Currently it is recommended to use the `uses-library` element together with `android:required="false"` as long as !SmartCard API is not part of the AOSP project. Keep in mind to take care of the issue that no Secure Element access is available on the phone indicated in logcat:
{{{
W/ActivityManager( 1113): Unable to start service Intent { act=org.simalliance.openmobileapi.service.ISmartcardService }: not found
}}}
Refer to the official documentation under [http://developer.android.com/guide/topics/manifest/uses-library-element.html uses-library element] for more information.


===Implement the SEService.!CallBack interface===
The Secure Element service uses an asynchronous callback mechanism to inform the application, when the service is connected. Therefore, the `SEService.Callback` interface is implemented in `MainActivity` with the callback method `serviceConnected()`.

{{{
import org.simalliance.openmobileapi.*;

public class MainActivity extends Activity implements SEService.CallBack {
  ...
  public void serviceConnected(SEService service) {
    //Log.i(LOG_TAG, "seviceConnected()");
  }
}
}}}


===Creating the View===
Let's not care too much about the user interface, just create a button which starts the communication with the applet on the Secure Element when pressed.<br/>
In `MainActivity.java`, add the following code to the `onCreate()` method.
{{{
@Override
public void onCreate(Bundle savedInstanceState) {
  final String LOG_TAG = "HelloSmartcard";

  super.onCreate(savedInstanceState);

  LinearLayout layout = new LinearLayout(this);
  layout.setLayoutParams(new LayoutParams(
          LayoutParams.WRAP_CONTENT,
          LayoutParams.WRAP_CONTENT));

  Button button = new Button(this);
  button.setLayoutParams(new LayoutParams(
          LayoutParams.WRAP_CONTENT,
          LayoutParams.WRAP_CONTENT));

  button.setText("Click Me");
  button.setOnClickListener(new OnClickListener() {
    public void onClick(View v) {
      // TODO: Secure Element access
    }
  });

  layout.addView(button);
  setContentView(layout);
}
}}}
Add the required Java imports for the new code manually or use `Ctrl+Shift+O` within Eclipse to organize all imports.<br/>

===Initialize the SEService ===
Create a handle to the SEService API. At the end of the `onCreate()` method, add
{{{
  try {
    Log.i(LOG_TAG, "creating SEService object");
    seService = new SEService(this, this);
  } catch (SecurityException e) {
    Log.e(LOG_TAG, "Binding not allowed, uses-permission org.simalliance.openmobileapi.SMARTCARD?");
  } catch (Exception e) {
    Log.e(LOG_TAG, "Exception: " + e.getMessage());
  }
 
}}}
and create a _SEService object within the _!MainActivity_ class
{{{
  private SEService seService; 
}}}
If the sample application is executed on the phone now, a security exception is thrown complaining about a missing _SMARTCARD_ permission. See the log output of the command when starting the application in its current stage
{{{
$ adb logcat *:v
}}}
In order to be allowed to use the !SmartCard API, an application must implement the `org.simalliance.openmobileapi.SMARTCARD` permission. This permission notifies a user when installing an application that requests access to a Secure Element.<br/>
Define the permission in the _!AndroidManifest.xml_ file
{{{
<uses-permission android:name="org.simalliance.openmobileapi.SMARTCARD"/>
}}}
and the sample application will launch properly.<br/>
Note that the constructor of SEService will automatically bind to the !SmartCardService component in the background. Since service binding is asynchronous in Android, the proper way to initialize the library is to wait for a notification event as discussed previously.<br/>
To clean up the service binding, call the shutdown method when the application is closing or is not using !SmartCardService anymore like in `onDestroy()`
{{{
@Override
protected void onDestroy() {
   if (seService != null && seService.isConnected()) {
      seService.shutdown();
   }
   super.onDestroy();
} 
}}}

===Accessing the Smart Card===
Add the following code snippet inside the _onClick()_ handler of the button
{{{
   try {
      Log.d(LOG_TAG, "Retrieve available readers...");
      Reader[] readers = seService.getReaders();
      if (readers.length < 1)
         return;

      Log.d(LOG_TAG, "Create Session from the first reader...");
      Session session = readers[0].openSession();

      Log.d(LOG_TAG,
      "Create logical channel within the session...");
      Channel channel = session.openLogicalChannel(new byte[] {
      (byte) 0xD2, 0x76, 0x00, 0x01, 0x18, 0x00, 0x02,
      (byte) 0xFF, 0x49, 0x50, 0x25, (byte) 0x89,
      (byte) 0xC0, 0x01, (byte) 0x9B, 0x01 });

      Log.d(LOG_TAG, "Send HelloWorld APDU command");
      byte[] respApdu = channel.transmit(new byte[] {
      (byte) 0x90, 0x10, 0x00, 0x00, 0x00 });

      channel.close();

      // Parse response APDU and show text but remove SW1 SW2 first 
      byte[] helloStr = new byte[respApdu.length - 2];
      System.arraycopy(respApdu, 0, helloStr, 0, respApdu.length - 2);
      Toast.makeText(MainActivity.this, new String(helloStr),	Toast.LENGTH_LONG).show();
   } catch (Exception e) {
      Log.e(LOG_TAG, "Error occured:", e);
      return;
   } 
}}}
In this code, a logical channel to the _!HelloSmartcard_ applet identified by its AID `D2 76 00 01 18 00 02 FF 49 50 25 89 C0 01 9B 01` is created. The _!HelloSmartcard_ applet
specific APDU command `90 10 00 00 00` is sent to retrieve the applet response.<br/>
The last two bytes of the response (=status word or SW1SW2=`90 00` on successful execution) are truncated and the result is displayed on the screen.<br/>

===Running the Application===
In Eclipse, click on Run or press `Ctrl+F11` to execute the sample on the phone.<br/>
Each time the applet is accessed, the counter is incremented by one and stored in NV memory on the Secure Element. This shows the data persistence of the applet installed on the Secure Element.<br/>
To debug the application, you need to
 * Add additional `Log.e()` messages
 * Run `$ logcat *:v` in a terminal to show all log messages
 * Use Eclipse to set breakpoints and step through the code

Other samples are available in SVN as well as a complete [http://seek-for-android.googlecode.com/svn/trunk/doc/index.html JavaDoc] for a complete reference.