#summary How to enable the emulator to talk to a SIM card connected through PC/SC

= Introduction =

The Android emulator is only supporting a primitive 'fake' SIM card which cannot be used to extend the Sim Toolkit framework. On real devices, the RIL library is very restrictive in terms of STK support.<br/>
This patch enables the Android emulator to forward any APDU traffic (AT+CRSM, AT+CPIN, etc. commands) to a real SIM card that is connected through a PC/SC card reader and accessible with pcsc-lite running on the host. Additionally, this patch adds the missing support for the Sim Toolkit framework to the emulator's RIL implementation (reference-ril).
<br/><br/>


== Applying the patch to the emulator sources ==

  * Download the [http://seek-for-android.googlecode.com/files/smartcard-webserver_1.0.tgz patch archive]
  * Unpack the patch archive: <code>tar xfvz smartcard-webserver_1.0.tgz</code>
  * Apply the patch(es) in the root folder of the Android source tree: <code>patch -p1 < emulator.patch</code>Note: the emulator extensions are no longer provided as a separate download file, but only together with e.g. the SCWS patches. However, the emulator extension patches (emulator.patch) still work without any additional patches.
  * Download and build pcsc-lite:
{{{
tar xfvj pcsc-lite-<version>.tar.bz2
cd <path/to/pcsc-lite>
./configure; make
}}}
  * Rebuild the emulator with PC/SC support: 
{{{
touch external/qemu/telephony/sim_card.c
touch external/qemu/android/cmdline-option.c
PCSCLITE_INCPATH=<path/to/pcsc-lite>/src/PCSC PCSCLITE_LIBPATH=<path/to/pcsc-lite>/src/.libs make
}}}
  * Create an AVD and launch the emulator:
{{{
android create avd -n Android_2.2 -t 12
ANDROID_SDK_ROOT=<path/to/android-sdk-linux> ./out/host/linux-x86/bin/emulator -avd Android_2.2 -system out/target/product/generic/system.img -pcsc <reader>
}}}
  * In the emulator output a card reader will get listed, e.g. _sim_card.c: using card reader Cherry XX44 00 00_
  * If a SIM Toolkit application is located on the SIM card inserted to the card reader, the Android SIM Toolkit (Stk) application can be used to use/test/debug the card applet.
http://seek-for-android.googlecode.com/svn/wiki/img/EmulatorExtensionScreenshot.png